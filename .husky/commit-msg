#!/usr/bin/env sh

# -------------------------------------------------------------------------
# [ Debug ç­†è¨˜ - 2025 Windows/GitBash ä¿®æ­£è£œä¸]
#
# èƒŒæ™¯:
# Husky æ¨™æº–å®‰è£ä¾è³´æ–¼ `. "$(dirname "$0")/_/h"` ä¾†è¼‰å…¥ç’°å¢ƒã€‚
# ç„¶è€Œï¼Œåœ¨ Windows ç’°å¢ƒ (ç‰¹åˆ¥æ˜¯ MinGW64/Git Bash) ä¸‹ï¼Œ
# é€é Shell Shim (pnpm/npx) å‘¼å«æŒ‡ä»¤æ™‚ï¼Œå¯èƒ½æœƒç™¼ç”Ÿã€Œéœé»˜å¤±æ•— (Silent Failures)ã€ï¼Œ
# å°è‡´éŒ¯èª¤ä»£ç¢¼ (Exit Code) è¢«ç³»çµ±åæ‰ï¼Œè®“ Git èª¤ä»¥ç‚ºæª¢æŸ¥é€šéã€‚
#
# è§£æ±ºæ–¹æ¡ˆ:
# æˆ‘ç¹é Husky çš„æŠ½è±¡å±¤èˆ‡å¥—ä»¶ç®¡ç†å™¨çš„åŒ…è£å±¤ (Shims)ï¼Œ
# ç›´æ¥ä½¿ç”¨ Node.js åŸ·è¡Œæª”å‘¼å« commitlint çš„æ ¸å¿ƒç¨‹å¼ï¼Œ
# é€™èƒ½ç¢ºä¿ç„¡è«–åœ¨å“ªç¨® Shell ç’°å¢ƒä¸‹ï¼Œéƒ½èƒ½ç²¾æº–æ•æ‰åˆ°æˆåŠŸæˆ–å¤±æ•—çš„ç‹€æ…‹ç¢¼ã€‚
# -------------------------------------------------------------------------

echo "--- ğŸ” [Hook] æ­£åœ¨é©—è­‰ Commit Message æ ¼å¼ ---"

# 1. å®šç¾©åŸ·è¡Œæª”è·¯å¾‘
# ç›´æ¥æŒ‡å‘ node_modules å…§éƒ¨çš„ JS æª”ï¼Œé¿é–‹ç³»çµ± Shell çš„è·¯å¾‘è§£æå•é¡Œ
COMMITLINT_JS="./node_modules/@commitlint/cli/cli.js"

# 2. å®‰å…¨æª¢æŸ¥ï¼šç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨
if [ ! -f "$COMMITLINT_JS" ]; then
  echo "âš ï¸  [è­¦å‘Š] æ‰¾ä¸åˆ° Commitlint åŸ·è¡Œæª”ï¼š$COMMITLINT_JS"
  echo "    è·³éæª¢æŸ¥ã€‚è«‹ç¢ºèªä¾è³´æ˜¯å¦å·²æ­£ç¢ºå®‰è£ (pnpm install)ã€‚"
  # ç‚ºäº†ä¸é˜»æ“‹é–‹ç™¼ï¼Œè‹¥å·¥å…·æå£å‰‡é è¨­æ”¾è¡Œ
  exit 0
fi

# 3. ä½¿ç”¨ Node.js ç›´æ¥åŸ·è¡Œ
# "$1" æ˜¯ Git æš«å­˜çš„ commit message æª”æ¡ˆè·¯å¾‘
node "$COMMITLINT_JS" --edit "$1"

# 4. é¡¯å¼æ•æ‰å›å‚³ç¢¼ (Exit Code)
EXIT_CODE=$?

# 5. æ ¹æ“šçµæœæ±ºå®šæ˜¯å¦æ””æˆª
if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "--- âŒ [æ””æˆª] Commit Message ä¸ç¬¦åˆ Conventional Commits è¦ç¯„ ---"
    echo "    è«‹ä½¿ç”¨æ¨™æº–é¡å‹: feat, fix, docs, style, refactor, test, build, ci, chore, revert"
    echo "    ç¯„ä¾‹: 'feat(user): add login functionality'"
    echo ""
    # å¼·åˆ¶å›å‚³é 0 ç‹€æ…‹ç¢¼ï¼Œå‘Šè¨´ Git æ”¾æ£„é€™æ¬¡æäº¤
    exit 1
fi

echo "--- âœ… [é€šé] Commit Message æ ¼å¼æ­£ç¢ºï¼ ---"
exit 0